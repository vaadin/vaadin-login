<!--
@license
Vaadin Login
Copyright (C) 2018 Vaadin Ltd
This program is available under Apache License Version 2.0, available at https://vaadin.com/license/
-->

<link rel="import" href="../../polymer/polymer-element.html">
<link rel="import" href="../../vaadin-themable-mixin/vaadin-themable-mixin.html">
<link rel="import" href="../../vaadin-element-mixin/vaadin-element-mixin.html">

<link rel="import" href="vaadin-login.html">
<link rel="import" href="vaadin-login-mixin.html">
<link rel="import" href="vaadin-login-overlay-element.html">


<dom-module id="vaadin-login-overlay">
  <template>
    <vaadin-login-overlay-element 
      id="overlay"
      opened="{{opened}}"
      focus-trap
      with-backdrop
      title="[[title]]"
      description="[[description]]">

      <vaadin-login
        theme="with-overlay"
        id="login"
        action="{{action}}"
        disabled="{{disabled}}"
        error="{{error}}"
        no-forgot-password="{{noForgotPassword}}"
        i18n="{{i18n}}"
        on-login="_handleEvent"
        on-forgot-password="_handleEvent">
      </vaadin-login>

    </vaadin-login-overlay-element>
  </template>
  <script>
    (function() {
      /**
       * `<vaadin-login-overlay>` is a Web Component.
        *
        * ```
        * <vaadin-login-overlay></vaadin-login-overlay>
        * ```
        *
        * @memberof Vaadin
        * @mixes Vaadin.ElementMixin
        * @mixes Vaadin.ThemableMixin
        * @mixes Vaadin.LoginMixin
        * @demo demo/index.html
        */
      class VaadinLoginOverlay extends Vaadin.LoginMixin(Vaadin.ElementMixin(Vaadin.ThemableMixin(Polymer.Element))) {
        static get is() {
          return 'vaadin-login-overlay';
        }

        static get properties() {
          return {
            /**
             * Defines the application description
             */
            description: {
              type: String,
              value: 'Application description',
              notify: true
            },
            opened: {
              type: Boolean,
              value: false,
              observer: '_onOpenedChange'
            },
            /**
             * Defines the application title
             */
            title: {
              type: String,
              value: 'App name'
            }
          };
        }

        static get observers() {
          return [
            '__i18nChanged(i18n.header.*)'
          ];
        }

        ready() {
          super.ready();

          this._preventClosingLogin = this._preventClosingLogin.bind(this);
        }

        connectedCallback() {
          super.connectedCallback();

          this.$.overlay.addEventListener('vaadin-overlay-outside-click', this._preventClosingLogin);
          this.$.overlay.addEventListener('vaadin-overlay-escape-press', this._preventClosingLogin);
        }

        disconnectedCallback() {
          super.disconnectedCallback();

          this.$.overlay.removeEventListener('vaadin-overlay-outside-click', this._preventClosingLogin);
          this.$.overlay.removeEventListener('vaadin-overlay-escape-press', this._preventClosingLogin);
          this.$.overlay.opened = false;
        }

        __i18nChanged(i18n) {
          const header = i18n.base;
          if (!header) {
            return;
          }
          this.title = header.title;
          this.description = header.description;
        }

        _preventClosingLogin(e) {
          e.preventDefault();
        }

        _handleEvent(e) {
          e.stopPropagation();
          const {
            detail,
            composed,
            cancelable,
            bubbles
          } = e;

          this.dispatchEvent(new CustomEvent(e.type, {bubbles, cancelable, composed, detail}));
        }

        _onOpenedChange() {
          if (!this.opened) {
            this.$.login.$.username.value = '';
            this.$.login.$.password.value = '';
            this.disabled = false;
            if (this._undoTeleport) {
              this._undoTeleport();
            }
          } else {
            this._undoTeleport = this._teleport(this._getElementsToTeleport());
          }
        }

        _teleport(elements) {
          const teleported = [];
          for (const e of elements) {
            this.$.overlay.appendChild(e);
            teleported.push(e);
          }
          // Function to undo the teleport
          return () => {
            while (teleported.length > 0) {
              this.appendChild(teleported.shift());
            }
          };
        }

        _getElementsToTeleport() {
          if (!this._elementsToTeleport) {
            this._elementsToTeleport = this.querySelectorAll('[slot=title]');
          }
          return this._elementsToTeleport;
        }
      }

      customElements.define(VaadinLoginOverlay.is, VaadinLoginOverlay);

      /**
       * @namespace Vaadin
       */
      window.Vaadin.VaadinLoginOverlay = VaadinLoginOverlay;
    })();
  </script>
</dom-module>
