<!--
@license
Copyright (c) 2018 Vaadin Ltd.
This program is available under Commercial Vaadin Add-On License 3.0 (CVALv3).
See <a href="https://vaadin.com/license/cval-3">the website</a> for the complete license.
-->

<link rel="import" href="../../polymer/polymer-element.html">
<link rel="import" href="../../vaadin-themable-mixin/vaadin-themable-mixin.html">
<link rel="import" href="../../vaadin-element-mixin/vaadin-element-mixin.html">
<link rel="import" href="../../vaadin-overlay/src/vaadin-overlay.html">

<link rel="import" href="vaadin-login.html">
<link rel="import" href="vaadin-login-mixin.html">

<dom-module id="vaadin-login-overlay-element-template">
  <template>
  <style>
      [part="overlay"] {
        outline: none;
      }

      [part="card"] {
        max-width: 100%;
        box-sizing: border-box;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      [part="brand"] {
        box-sizing: border-box;
        overflow: hidden;
        flex-grow: 1;
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
      }

      [part="brand"] h1 {
        color: inherit;
        margin: 0;
      }
    </style>
    <section part="card">
      <div part="brand">
        <h1>[[title]]</h1>
        <p>[[description]]</p>
      </div>
      <slot></slot>
    </section>
  </template>
  <script>
    (function() {
      let memoizedTemplate;

      /**
       * The ovelay element
       *
       * @memberof Vaadin
       * @private
      */
      class LoginOverlayElement extends Vaadin.OverlayElement {
        static get is() {
          return 'vaadin-login-overlay-element';
        }

        static get template() {
          if (!memoizedTemplate) {
            // Clone the superclass template
            memoizedTemplate = super.template.cloneNode(true);

            // Retrieve the elements from component's template
            const thisTemplate = Polymer.DomModule.import(this.is + '-template', 'template');
            const card = thisTemplate.content.querySelector('[part=card]');
            const styles = thisTemplate.content.querySelector('style');

            // Append elements to cloned template
            const content = memoizedTemplate.content.querySelector('#content');
            content.replaceChild(card, content.children[0]);
            content.appendChild(styles);
          }

          return memoizedTemplate;
        }
      }

      customElements.define(LoginOverlayElement.is, LoginOverlayElement);
    })();
  </script>
</dom-module>

<dom-module id="vaadin-login-overlay">
  <template>
    <vaadin-login-overlay-element id="overlay" opened="{{opened}}" focus-trap with-backdrop title="[[title]]" description="[[description]]">
      <vaadin-login
        theme="with-overlay"
        id="login"
        action="{{action}}"
        disabled="{{disabled}}"
        error="{{error}}"
        no-forgot-password="{{noForgotPassword}}"
        i18n="{{i18n}}"
        title="{{title}}"
        description="{{description}}"
        on-login="_handleEvent"
        on-forgot-password="_handleEvent">
      </vaadin-login>
    </vaadin-login-overlay-element>
  </template>
  <script>
    (function() {
      /**
       * `<vaadin-login-overlay>` is a Web Component.
        *
        * ```
        * <vaadin-login-overlay></vaadin-login-overlay>
        * ```
        *
        * @memberof Vaadin
        * @mixes Vaadin.ElementMixin
        * @mixes Vaadin.ThemableMixin
        * @mixes Vaadin.LoginMixin
        * @demo demo/index.html
        */
      class VaadinLoginOverlay extends Vaadin.LoginMixin(Vaadin.ElementMixin(Vaadin.ThemableMixin(Polymer.Element))) {
        static get is() {
          return 'vaadin-login-overlay';
        }

        static get properties() {
          return {
            /**
             * Defines the application description
             */
            description: {
              type: String,
              value: 'Application description',
              notify: true
            },
            opened: {
              type: Boolean,
              value: false,
              observer: '_onOpenedChange',
              notify: true
            },
            /**
             * Defines the application title
             */
            title: {
              type: String,
              value: 'App name',
              notify: true
            }
          };
        }

        static get observers() {
          return [
            '__i18nChanged(i18n.header.*)'
          ];
        }

        ready() {
          super.ready();

          this._preventClosingLogin = this._preventClosingLogin.bind(this);
        }

        connectedCallback() {
          super.connectedCallback();

          this.$.overlay.addEventListener('vaadin-overlay-outside-click', this._preventClosingLogin);
          this.$.overlay.addEventListener('vaadin-overlay-escape-press', this._preventClosingLogin);
        }

        disconnectedCallback() {
          super.disconnectedCallback();

          this.$.overlay.removeEventListener('vaadin-overlay-outside-click', this._preventClosingLogin);
          this.$.overlay.removeEventListener('vaadin-overlay-escape-press', this._preventClosingLogin);
          this.$.overlay.opened = false;
        }


        __i18nChanged(i18n) {
          const header = i18n.base;
          if (!header) {
            return;
          }
          this.title = header.title;
          this.description = header.description;
        }

        _preventClosingLogin(e) {
          e.preventDefault();
        }

        _handleEvent(e) {
          e.stopPropagation();
          const {
            detail,
            composed,
            cancelable,
            bubbles
          } = e;

          this.dispatchEvent(new CustomEvent(e.type, {bubbles, cancelable, composed, detail}));
        }

        _onOpenedChange() {
          if (!this.opened) {
            this.$.login.$.username.value = '';
            this.$.login.$.password.value = '';
            this.disabled = false;
          }
        }
      }

      customElements.define(VaadinLoginOverlay.is, VaadinLoginOverlay);

      /**
       * @namespace Vaadin
       */
      window.Vaadin.VaadinLoginOverlay = VaadinLoginOverlay;
    })();
  </script>
</dom-module>
